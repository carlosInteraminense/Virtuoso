<!DOCTYPE HTML>
<html>
	<head>
		<title>Virtuoso</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/default.css" />
		<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		<script>
		var user = window.localStorage.getItem("user");
		if (!user) {
			window.location.href = "index.html";
		};
		user = JSON.parse(user);
		var data = "user_id=" + user.id;
		$.ajax({
			type: 'post',
			url: "http://150.165.75.202/html/virtuoso/update.php",
			cache: false,
			async: false,
			data: data,
			success: function(json) { 
				if (json["success"]) {
					user.email = json.email;
					user.name = json.name;
					user.songs = json.songs;
					window.localStorage.setItem("user", JSON.stringify(user));
				} else {
					window.localStorage.clear();
					window.location.href = "index.html";
				}
			},
			error: function(message) {
				window.localStorage.clear();
				window.location.href = "index.html";
			}
		});
		</script>
	</head>
	<body>	
		<nav class="navbar navbar-default">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
						<span class="sr-only">Toggle navigation</span>
					</button>
					<a class="navbar-brand" href="#"><img alt="Brand" src="images/logo_ico.png" width="25px" height="25px"></a>
				</div>
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<a href="#"><p class="navbar-text"></p></a>
					<ul class="nav navbar-nav">
						<li><button id="upload" type="button" class="btn btn-primary navbar-btn" data-toggle="modal" data-target="#myModal">Upload song</button></li>
					</ul>
					<button id="logout" type="button" class="btn btn-default navbar-btn navbar-right">Log out</button>
				</div><!-- /.navbar-collapse -->
			</div><!-- /.container-fluid -->
		</nav>
		<div class="col-md-6 col-md-offset-3 col-xs-10 col-xs-offset-1 panel">
			<ul class="nav nav-tabs">
			  <li role="presentation" class="active"><a href="#">Genre</a></li>
			  <li role="presentation"><a href="#">Mood</a></li>
			</ul>
			<div id="carousel-genre" class="carousel slide" data-ride="carousel" data-interval="false">
			  <!-- Indicators -->
			  <ol class="carousel-indicators" style="bottom: 0;">
				<li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
				<li data-target="#carousel-example-generic" data-slide-to="1"></li>
				<li data-target="#carousel-example-generic" data-slide-to="2"></li>
				<li data-target="#carousel-example-generic" data-slide-to="3"></li>
				<li data-target="#carousel-example-generic" data-slide-to="4"></li>
				<li data-target="#carousel-example-generic" data-slide-to="5"></li>
				<li data-target="#carousel-example-generic" data-slide-to="6"></li>
			  </ol>
			  <!-- Wrapper for slides -->
			  <div class="carousel-inner" role="listbox">
				<div class="item active">
				  <img src="images/genres/brega.jpg" alt="Brega" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/genres/disco.jpg" alt="Disco" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/genres/forro.jpg" alt="Forró" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/genres/mpb.jpg" alt="MPB" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/genres/repente.jpg" alt="Repente" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/genres/rock.jpg" alt="Rock" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/genres/sertanejo.jpg" alt="Sertanejo" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
			  </div>
			  <!-- Controls -->
			  <a class="left carousel-control" href="#carousel-genre" role="button" data-slide="prev">
				<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
				<span class="sr-only">Previous</span>
			  </a>
			  <a class="right carousel-control" href="#carousel-genre" role="button" data-slide="next">
				<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
				<span class="sr-only">Next</span>
			  </a>
			</div>
			<div id="carousel-mood" class="carousel slide" data-ride="carousel" data-interval="false" style="display: none;">
			  <!-- Indicators -->
			  <ol class="carousel-indicators" style="bottom: 0;">
				<li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
				<li data-target="#carousel-example-generic" data-slide-to="1"></li>
				<li data-target="#carousel-example-generic" data-slide-to="2"></li>
				<li data-target="#carousel-example-generic" data-slide-to="3"></li>
				<li data-target="#carousel-example-generic" data-slide-to="4"></li>
				<li data-target="#carousel-example-generic" data-slide-to="5"></li>
				<li data-target="#carousel-example-generic" data-slide-to="6"></li>
			  </ol>
			  <!-- Wrapper for slides -->
			  <div class="carousel-inner" role="listbox">
				<div class="item active">
				  <img src="images/moods/happiness.jpg" alt="Happiness" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/moods/sadness.jpg" alt="Sadness" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/moods/anger.jpg" alt="Anger" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/moods/fear.jpg" alt="Fear" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/moods/disgust.jpg" alt="Disgust" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/moods/surprise.jpg" alt="Surprise" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
				<div class="item">
				  <img src="images/moods/neutral.jpg" alt="Neutral" style="width: 100%;">
				  <div class="carousel-caption">
				  </div>
				</div>
			  </div>

			  <!-- Controls -->
			  <a class="left carousel-control" href="#carousel-mood" role="button" data-slide="prev">
				<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
				<span class="sr-only">Previous</span>
			  </a>
			  <a class="right carousel-control" href="#carousel-mood" role="button" data-slide="next">
				<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
				<span class="sr-only">Next</span>
			  </a>
			</div>
			<ul class="list-group" id="songs">
			</ul>
		</div>
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		  <div class="modal-dialog">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Upload song</h4>
			  </div>
			  <div class="modal-body">
				<form id="formUpload" method="POST" enctype="multipart/form-data">
					<center>
						<p>Select a song to upload</p>
						<input type="file" name="fileToUpload" />
					</center>
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="submit" class="btn btn-success" id="uploadsong" data-loading-text="Uploading..." autocomplete="off">Upload</button>
				  </div>
			  </form>
			</div><!-- /.modal-content -->
		  </div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		<script>
			var genres = ["Brega", "Disco", "Forró", "MPB", "Repente", "Rock", "Sertanejo"];
			var moods = ["Happiness", "Sadness", "Anger", "Fear", "Disgust", "Surprise", "Neutral"];
			var medias = {};
			function filterSongs(type, index) {
				var list = [];
				if (type == "genre") {
					for (var i = 0; i < user.songs.length; i++) {
						if (user.songs[i]["genre"].toLowerCase() == genres[index].toLowerCase()) {
							list.push(user.songs[i]);
						}
					}
				} else if (type == "mood") {
					for (var i = 0; i < user.songs.length; i++) {
						if (user.songs[i]["mood"].toLowerCase() == moods[index].toLowerCase()) {
							list.push(user.songs[i]);
						}
					}
				}
				return list;
			}
			function addSong(song) {
				user.songs.push(song);
				window.localStorage.setItem("user", JSON.stringify(user));
			}
			function removeSong(name) {
				for (var i = 0; i < user.songs.length; i++) {
					if (user.songs[i]["name"] == name) {
						user.songs.splice(i, 1);
						window.localStorage.setItem("user", JSON.stringify(user));
						return true;
					}
				}
				return false;
			}
			function fillList(type, index) {
				$("#songs").html("");
				var list = filterSongs(type, index);
				for (var i = 0; i < list.length; i++) {
					var url = "http://150.165.75.202/html/virtuoso/songs/" + user.id + "/" + list[i].name;
					$("#songs").append('<li class="list-group-item"><audio id="song' + i + '" src="' + url + '" preload="false"></audio><button class="glyphicon glyphicon-play play-song" style="float: left;" aria-hidden="true" data-name="' + list[i].name + '"></button><button class="glyphicon glyphicon-pause pause-song" style="float: left;"  aria-hidden="true" data-name="' + list[i].name + '"></button> ' + list[i].name + ' <button class="glyphicon glyphicon-remove remove-song" style="float: right;" aria-hidden="true" data-name="' + list[i].name + '"></button></li>');
					medias[list[i].name] = $("#songs").find("#song" + i);
				}
				if (list.length == 0) {
					$("#songs").append("<li class='list-group-item'>This playlist has no song yet.</li>");
				}
			}
			$(function() {
				var type = "genre";
				var genreCarouselIndex = 0;
				var moodCarouselIndex = 0;
				fillList(type, genreCarouselIndex);
				$(".navbar-text").text("Welcome, " + (user["name"] == "" ? user["email"] : user["name"]));
				$("#logout").click(function() {
					window.localStorage.clear();
					window.location.href = "index.html";
				});
				$(".item img").css("height", $("#carousel-genre").width() / 3 + "px");
				$(window).resize(function() {
					$(".item img").css("height", $("#carousel-genre").width() / 3 + "px");
				});
				$(".nav-tabs li").click(function() {
					var text = $(this).text();
					if (text == "Genre") {
						$(".nav-tabs li:nth-child(1)").addClass("active");
						$(".nav-tabs li:nth-child(2)").removeClass("active");
						$("#carousel-genre").show();
						$("#carousel-mood").hide();
						type = "genre";
						fillList("genre", genreCarouselIndex);
					} else if (text == "Mood") {
						$(".nav-tabs li:nth-child(1)").removeClass("active");
						$(".nav-tabs li:nth-child(2)").addClass("active");
						$("#carousel-genre").hide();
						$("#carousel-mood").show();
						type = "mood";
						fillList("mood", moodCarouselIndex);
					}
				});
				$("#formUpload input[name='user_id']").val(user.id);
				$("#formUpload").submit(function() {
					$("#uploadsong").button("loading");
					var request = new FormData($("input[name='fileToUpload']"));
					$.each($("input[name='fileToUpload']")[0].files, function(i, file) {
						request.append("fileToUpload", file);
					});
					request.append("user_id", user.id);
					$.ajax({
						type: 'post',
						url: "http://150.165.75.202/html/virtuoso/upload.php",
						cache: false,
						contentType: false,
						processData: false,
						data: request,
						success: function(json) {
							$("#uploadsong").button("reset");
							if (json["success"]) {
								addSong(json);
								$("#formUpload")[0].reset();
								fillList(type, type == "mood" ? moodCarouselIndex : genreCarouselIndex);
								alert("Song was uploaded successfully on playlists '" + json["genre"] + "' and '" + json["mood"] + "'.");
							} else {
								alert(json["message"]);
							}
						},
						error: function(message) {
							console.log(message);
							$("#uploadSong").button("reset");
							alert(message);
						}
					});
					return false;
				});
				$('#carousel-genre').on('slide.bs.carousel', function (event) {
				  if (event.direction == "right") {
					if (genreCarouselIndex == 0) {
						genreCarouselIndex = genres.length - 1;
					} else {
						genreCarouselIndex -= 1;
					}
				  } else if (event.direction == "left") {
					if (genreCarouselIndex >= genres.length - 1) {
						genreCarouselIndex = 0;
					} else {
						genreCarouselIndex += 1
					}
				  }
				  fillList("genre", genreCarouselIndex);
				});
				$('#carousel-mood').on('slide.bs.carousel', function (event) {
				  if (event.direction == "right") {
					if (moodCarouselIndex == 0) {
						moodCarouselIndex = moods.length - 1;
					} else {
						moodCarouselIndex -= 1;
					}
				  } else if (event.direction == "left") {
					if (moodCarouselIndex >= moods.length - 1) {
						moodCarouselIndex = 0;
					} else {
						moodCarouselIndex += 1
					}
				  }
				  fillList("mood", moodCarouselIndex);
				});
				$(this).on("click", ".remove-song", function() {
					var name = $(this).data("name");
					var data = "user_id=" + user.id + "&name=" + name; 
					var obj = $(this);
					$.ajax({
						type: 'post',
						url: "http://150.165.75.202/html/virtuoso/delete_song.php",
						cache: false,
						data: data,
						success: function(json) {
							if (json["success"]) {
								$(obj).parent().fadeOut(function() {
									if (!removeSong(name)) {
										alert("Could not find song.");
									} else {
										fillList(type, type == "genre" ? genreCarouselIndex : moodCarouselIndex);
									}
								});
							} else {
								alert(json["message"]);
							}
						},
						error: function(message) {
							alert(message);
						}
					});
				});
				$(this).on("click", ".play-song", function() {
					var name = $(this).data("name");
					$(medias[name])[0].play();
				});
				$(this).on("click", ".pause-song", function() {
					var name = $(this).data("name");
					$(medias[name])[0].pause();
				})
			});
		</script>
	</body>
</html>
